{% extends 'dashboard/index.html' %}
{% load mathfilters %}
{% load humanize %}

{% block dashoard_title %}
Ledger Report -
{% endblock %}


{% block dashboard_heading %}
<h1 class="h5 mb-0 text-gray-800">
    Ledger Report
</h1>

<style>
    table td,
    th {
        padding: 0px !important;
    }
</style>

{% endblock %}


{% block dashboard_content %}


<form method="post">
    {% csrf_token %}
    <div class="row">
        <div class="col-6 mb-2">
            <label for="company">Choose Company</label>
            <select name="company" class="form-control" id="company">
                {% if selected_company == "All" %}
                <option value="All" selected>All</option>
                {% else %}
                <option value="All">All</option>
                {% endif %}
                {% for item in global_companies %}
                {% if selected_company == item.id %}
                <option value="{{item.id}}" selected>{{item}}</option>
                {% else %}
                <option value="{{item.id}}">{{item}}</option>
                {% endif %}
                {% endfor %}
            </select>
        </div>
        <div class="col-6 mb-2">
            <label for="accounts">Choose Account</label>
            <select name="accounts" class="form-control" id="accounts">
                <option value="" selected disabled hidden>Choose Account</option>
                {% for item in accounts %}
                {% if journal.first.account.id == item.id %}
                <option value="{{item.id}}" selected>{{item.ledger_name}}</option>
                {% else %}
                <option value="{{item.id}}">{{item.ledger_name}}</option>
                {% endif %}
                {% endfor %}
            </select>
        </div>

    </div>
    <button class="btn btn-primary" type="submit">Search</button>
</form>

{% if journal %}

<h6 class="text-center mt-1">{{journal.first.account.ledger_name}}</h6>

<div class="table-responsive">
    <table class="table compact display table-bordered table-hover" id="ledger_table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Particulars</th>
                <th>Dr. Amount</th>
                <th>Cr. Amount</th>
            </tr>
        </thead>
        <tbody>
            {% if journal.first.account.opening_balance > 0 %}
            {% if journal.first.account.balance_in == "Debit" %}
            <tr>
                <td align="center">{{journal.first.account.opening_date|date:"d/M/Y"}}</td>
                <td>Opening Balance</td>

                <td align="right" data-order="{{journal.first.account.opening_balance}}">
                    {{journal.first.account.opening_balance}}</td>

                <td data-order="0">-</td>

            </tr>
            {% else %}
            <tr>
                <td>{{journal.first.account.opening_date|date:"d/M/Y"}}</td>
                <td>Opening Balance</td>

                <td data-order="0">-</td>

                <td align="right" data-order="{{journal.first.account.opening_balance}}">
                    {{journal.first.account.opening_balance}}</td>
            </tr>
            {% endif %}
            {% endif %}
            {% for item in journal %}
            {% if item.dr_cr == "Debit" %}
            <tr>
                <td align="center">{{item.journal_entry.date|date:"d/M/Y"}}</td>
                <td>{{item.particular}}</td>

                <td align="right" data-order="{{item.amount|floatformat:2}}">{{item.amount|floatformat:2|intcomma}}</td>

                <td align="center" data-order="0">-</td>
            </tr>
            {% else %}
            <tr>
                <td align="center">{{item.journal_entry.date|date:"d/M/Y"}}</td>
                <td>{{item.particular}}</td>


                <td align="center" data-order="0">-</td>
                <td align="right" data-order="{{item.amount|floatformat:2}}">{{item.amount|floatformat:2|intcomma}}</td>
            </tr>
            {% endif %}
            {% endfor %}


            {% if total_dr_amount > total_cr_amount %}
            <tr>
                <td align="center">{{today_date|date:'d/M/Y'}}</td>
                <td>Closing Balance</td>


                <td data-order="0" align="center">-</td>
                <td align="right" data-order="{{total_dr_amount|sub:total_cr_amount|floatformat:2}}">
                    {{total_dr_amount|sub:total_cr_amount|floatformat:2|intcomma}}</td>
            </tr>
            {% endif %}
            {% if total_cr_amount > total_dr_amount %}
            <tr>
                <td align="center">{{today_date|date:'d/M/Y'}}</td>
                <td>Closing Balance</td>


                <td align="right" data-order="{{total_cr_amount|sub:total_dr_amount|floatformat:2}}">
                    {{total_cr_amount|sub:total_dr_amount|floatformat:2|intcomma}}</td>
                <td data-order="0" align="center">-</td>
            </tr>
            {% endif %}


        </tbody>

        <tfoot>
            <tr>
                <td colspan="2">Total</td>

                <td align="right"></td>
                <td align="right"></td>
            </tr>
        </tfoot>

    </table>
</div>


{% endif %}






{% endblock %}

{% block js %}
<script src="https://cdn.datatables.net/plug-ins/1.13.4/api/sum().js"></script>
<script>


    var selected_ids = []
    $(document).ready(function () {

        jQuery.fn.dataTable.Api.register('sum()', function () {
            return this.flatten().reduce(function (a, b) {
                var x = parseFloat(a);
                var y = parseFloat($(b).attr('data-order'));

                return parseFloat((x + y).toFixed(2))
            }, 0);
        })
        var table = new DataTable('#ledger_table', {
            // options
            dom: 'BQlfrtip',
            order: [[0, 'asc']],
            columnDefs: [
                { "type": "date", "targets": 0 },

            ],

            buttons: [
                {
                    extend: 'collection',
                    text: 'Export',
                    buttons: [
                        'copy',
                        'excel',
                        'csv',
                        'pdf',
                        'print'
                    ]
                },

            ],
            lengthMenu: [
                [10, 25, 50, -1],
                [10, 25, 50, 'All'],
            ],
            drawCallback: function () {
                var api = this.api();
                $(api.table().column(2).footer()).html(
                    api.column(2, { page: 'current' }).nodes().sum()
                );

                $(api.table().column(3).footer()).html(
                    api.column(3, { page: 'current' }).nodes().sum()
                );


            }


        });
        document.querySelector('.dtsb-title').style.display = 'none'
    })




</script>
{% endblock %}