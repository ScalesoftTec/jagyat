{% extends 'dashboard/index.html' %}
{% load custom_tags %}
{% load mathfilters %}
{% load humanize %}

{% block dashoard_title %} Cash Ledger| {% endblock %}

{% block dashboard_heading %}
<h1 class="h4 mb-0 text-gray-800">
  Cash Statement
</h1>

{% endblock %}


{% block dashboard_content %}

<style>
  .dtsb-button {
    margin: 0 !important;
    padding: 5px 10px !important;
    font-size: 12px !important;
    border-radius: 10px !important;
    background-color: #280466 !important;
    color: #ffffff !important;
  }

  .dtsb-button:hover {

    font-size: 12px !important;

    background-color: #280466 !important;
    color: #ffffff !important;
  }

  .dtsb-criteria select {
    font-size: 12px !important;
  }

  tfoot tr td {
    color: white !important;
  }
</style>

<div>
  <form action="" name="bankForm" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="row">
      
      <div class="col-2">
        <label for="from_date">From</label>
        <input type="date" name="from_date" id="from_date" value="{{from_date|date:'Y-m-d'}}"
          class="form-control form-control-sm" required />
      </div>

      <div class="col-2">
        <label for="to_date">To</label>
        <input type="date" name="to_date" id="to_date" value="{{to_date|date:'Y-m-d'}}"
          class="form-control form-control-sm" required />
      </div>
   
     
      <div class="col-2">
        <label for="opening_balance">Type</label>
        <select name="opening_balance_type" id="opening_balance_type" class="form-control form-control-sm">
          {% if opening_balance_type == 'WOP' %}
          <option value="WOP" selected>Only Within Date Range</option>
          {% else %}
          <option value="WOP">Only Within Date Range</option>
          {% endif %}
          {% if opening_balance_type == 'WP' %}
          
          <option value="WP" selected>With Opening Balance</option>
          {% else %}
          <option value="WP">With Opening Balance</option>
        
          {% endif %}
        </select>
      </div>
      <div class="col-2 mt-4">
        <button class="btn btn-sm btn-primary" type="submit">Get Report</button>
      </div>
    </div>
  </form>
</div>



<div class="table-reponsive">

  <table class="table table-primary table-bordered  compact display" id="invoice_table">
    <thead>
      <tr>

        <th scope="col">Company</th>
        <th scope="col">Customer</th>
        <th scope="col">Inst. No</th>
        <th scope="col">Voucher Date</th>
        <th scope="col">Debit Amount</th>
        <th scope="col">Credit Amount</th>
        <th scope="col">Voucher Type</th>


      </tr>
    </thead>
    <tbody>
      {% if opening_balance_type == "WP" %}
      <tr>

        <td>-</td>

        <td>

          {{opening_report.customer}}
         
        </td>
       
        <td>-</td>
     
        <td></td>

        {% if opening_report.type == "Debit" %}
        <td align="right" data-order="{{opening_report.amount|floatformat:2}}">
        
          
            {{ opening_report.amount|floatformat:2|intcomma }}
         
        </td>
        {% else %}
        <td align="center" data-order="0">-</td>
        {% endif %}

        {% if opening_report.type == "Credit" %}
        <td align="right" data-order="{{opening_report.amount|floatformat:2}}">
          {{ opening_report.amount|floatformat:2|intcomma }}
       </td>
        {% else %}
        <td align="center" data-order="0">-</td>
        {% endif %}

        <td>
          -
        </td>


      </tr>
      {% endif %}
      {% for data in report %}
      <tr>

        <td>{{data.company}}</td>

        <td>
          {% if data.customer %}
          {{data.customer}}
          {% else %}
          Self
          {% endif %}
        </td>
        {% if data.no %}
        <td>{{data.no}}</td>
        {% else %}
        <td>-</td>
        {% endif %}
        <td>{{data.date|date:'Y-m-d'}}</td>

        {% if data.type == "Debit" %}
        <td align="right" data-order="{{data.amount|floatformat:2}}">
        {% if not data.clearing_date %}
          <a href="#"  data-toggle="modal" data-target="#debitModal{{ forloop.counter }}">
            {{ data.amount|floatformat:2|intcomma }}
          </a>
          {% else %}
          <a href="#">
            {{ data.amount|floatformat:2|intcomma }}
          </a>
          {% endif %}
        </td>
        {% else %}
        <td align="center" data-order="0">-</td>
        {% endif %}

        {% if data.type == "Credit" %}
        <td align="right" data-order="{{data.amount|floatformat:2}}">
          {% if not data.clearing_date %}
            <a href="#"  data-toggle="modal" data-target="#debitModal{{ forloop.counter }}">
              {{ data.amount|floatformat:2|intcomma }}
            </a>
            {% else %}
            <a href="#">
              {{ data.amount|floatformat:2|intcomma }}
            </a>
            {% endif %}
          </td>
        {% else %}
        <td align="center" data-order="0">-</td>
        {% endif %}

        <td>
          {% if data.from == "R" %}
          Receipt
          {% elif data.from == "P" %}
          Payment
          {% else %}
          Contra
          {% endif %}
        </td>

      </tr>
      
      {% endfor %}

      
    </tbody>
    <tfoot>
      <tr>

        <td colspan="3"></td>
        <td>Total</td>
        
        <td class="text-right" align="right"></td>
        <td class="text-right" align="right"></td>
      </tr>
      <tr>
        <td colspan="3"></td>
      
        <th class="text-white">Closing Balance</th>
        <td colspan="2" class="text-white"><h6 class="text-white">{{closing_balance|floatformat:2|intcomma}}</h6></td>
        
  
      </tr>
    </tfoot>
  </table>
</div>



{% endblock %}

{% block js %}

<script>
  var selected_ids = []
  $(document).ready(function () {

    jQuery.fn.dataTable.Api.register('sum()', function () {
      return this.flatten().reduce(function (a, b) {
        var x = parseFloat(a);
        var y = parseFloat($(b).attr('data-order'));

        return parseFloat(x + y).toFixed(2)
      }, 0);
    });

    let table = new DataTable('#invoice_table', {
      // options
      dom: 'BQlfrtip',
      "columnDefs": [
        { "type": "date", "targets": 3 }
      ],

      lengthMenu: [
        [10, 25, 50, -1],
        [10, 25, 50, 'All'],
      ],
      buttons: [
        {
          extend: 'collection',
          text: 'Export',
          "ordering": false,
          buttons: [
            'copy',
            'excel',
            'csv',
            'pdf',
         
          ]
        },

      ],
      drawCallback: function () {
        var api = this.api();
        $(api.table().column(4).footer()).html(
          api.column(4, { page: 'current' }).nodes().sum()
        );
        $(api.table().column(5).footer()).html(
          api.column(5, { page: 'current' }).nodes().sum()
        );




      }

    });
    document.querySelector('.dtsb-title').style.display = 'none'
  })

  

</script>
{% endblock %}