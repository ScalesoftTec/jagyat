{% extends 'dashboard/index.html' %}

{% block dashboard_heading %}
<h1 class="h4 mb-0 text-gray-800">
     List of bills
</h1>

{% endblock %}


{% block dashboard_content %}



<div class="row ">
 
    <div class="col-12">
    

        <form method="post">
            {% csrf_token %}
            <!-- <input type="hidden" name="choose_option" value="month" id="choose_option"> -->
            <input type="hidden" name="choose_option" value="date" id="choose_option">

            <div class="row">

                <div class="col-md-4 col-sm-12 mb-3"  id="choose_by_date">
                    <div class="row">
                        <div class="col-md-6 col-sm-12">
                            <label for="from_date">From</label>
                            <input type="date" name="from_date" value="{{from_date|date:'Y-m-d'}}" class="form-control" id="from_date" >
                        </div>
                        <div class="col-md-6 col-sm-12">
                            <label for="to_date">To</label>
                            <input type="date" name="to_date" value="{{to_date|date:'Y-m-d'}}" class="form-control" id="to_date" >
                        </div>
                    </div>
                </div>

             

                <div class="col-md-3 col-sm-12 mb-3">
                    <button type="submit" style="margin-top: 33px;" class=" btn btn-primary">Submit</button>
                </div>
            </div>
        </form>
    </div>

</div>

<div class="mb-3">
  <span style="display: inline-block; background-color: #28a745; color: white; padding: 5px 12px; border-radius: 4px; margin-right: 10px; font-weight: 600;">
    Paid
  </span>
  <span style="display: inline-block; background-color: #dc3545; color: white; padding: 5px 12px; border-radius: 4px; font-weight: 600;">
    Overdue
  </span>

  <span style="display: inline-block; background-color: rgb(255, 234, 0); color: white; padding: 5px 12px; border-radius: 4px; font-weight: 600;">
    Partial Paid
  </span>
</div>
<div class="table-responsive">


<table class="table compact table-primary table-bordered" id="bop_table">
    <thead>
      <tr>
        <th scope="col">S. No.</th>
        <th scope="col">Invoice No</th>
        <th scope="col">Date Of Invoice</th>
        <th scope="col">Due Date </th>
        <th scope="col">Due Days </th>
        <!-- <th scope="col">Transactions</th>
        <th scope="col">Details</th> -->
        <th scope="col">Amount</th>
        <th scope="col">Payment</th>
        <th scope="col">Balance</th>

        <th scope="col">Actions</th>
        
      </tr>
    </thead>
    <tbody>
        {% for data in bop %}
      <tr class="{% if data.balance == 0 %}table-success{% elif  data.days_left < 0 %}table-danger {% elif  data.balance > 0  and data.balance != data.amount and  data.payment != data.amount %}table-warning{% endif %}">
        <th scope="row">{{ forloop.counter }}</th>
        <th scope="row">{{data.invoice_no}}</th>
        <td>{{ data.date_of_invoice }}</td>
        <td>{{ data.due_date }}</td>
        <td>{{ data.days_left }}</td>
        <!-- <td>{{ data.transactions }}</td>
        <td>{{ data.details }}</td> -->
        <td data-order="{{ data.amount|floatformat:2 }}">{{ data.amount }}</td>
        <td data-order="{{ data.payments|floatformat:2 }}">{{ data.payments }}</td>
        <td data-order="{{ data.balance|floatformat:2 }}">{{ data.balance }}</td>
       
        
        <td>
         
    {% if data.bill_upload %}
    <a class="btn btn-xs btn-primary" href="{{ data.bill_upload.url }}" target="_blank">
      <i class="fas fa-file-pdf"></i> View PDF
    </a>
  {% else %}
    <span>No PDF uploaded</span>
  {% endif %}
        </td>
    
      </tr>
      {% endfor %}
     
    </tbody>
    <tfoot>
      <tr>
        <td colspan="5" style="text-align:right; color:white"><strong>Total:</strong></td>
        <td style="color:white" id="amount_total"></td>
        <td style="color:white" id="payment_total"></td>
        <td style="color:white" id="balance_total"></td>
        <td></td>
      </tr>
    </tfoot>
  </table>

</div>


{% endblock %}


{% block js %}



<script>
  $(document).ready(function () {

                
jQuery.fn.dataTable.Api.register('sum()', function () {
    return this.flatten().reduce(function (a, b) {
    var x = parseFloat(a) || 0;
    var y = parseFloat($(b).attr('data-order')) || 0;
    return parseFloat(x + y).toFixed(2);
    }, 0);
});
    let table = new DataTable('#bop_table', {
        // options
        dom: 'BQlfrtip',
        order: [[5, 'desc']],
        buttons: [
        {
            extend: 'collection',
            text: 'Export',
            buttons: [
                'copy',
                'excel',
                'csv',
                'pdf',
               
            ]
        },

        ],
    drawCallback: function () {
    let api = this.api();

    let amountsum = 0;
    api.column(5, { page: 'current' }).nodes().each(function (node) {
        const val = parseFloat($(node).attr('data-order')) || 0;
        amountsum += val;
    });
    let paymentSum = 0;
    api.column(6, { page: 'current' }).nodes().each(function (node) {
        const val = parseFloat($(node).attr('data-order')) || 0;
        paymentSum+= val;
    });

    let balancesum = 0;
    api.column(7, { page: 'current' }).nodes().each(function (node) {
        const val = parseFloat($(node).attr('data-order')) || 0;
        balancesum += val;
    });

    

        $('#amount_total').html(amountsum.toFixed(2));
        $('#payment_total').html(paymentSum.toFixed(2));
        $('#balance_total').html(balancesum.toFixed(2));
       
    }

    });
  
    document.querySelector('.dtsb-title').style.display = 'none' });


</script>
{% endblock %}



