{% extends 'dashboard/index.html' %} 
{% block dashoard_title %} Acccounting | {% endblock %} 
{% block dashboard_heading %}
{% load static %}
{% load custom_tags %}
<style>
    @keyframes blinker {
      50% { opacity: 0; }
    }

  a {
    text-decoration: none !important;
  }
  .blue {
    background-color: #065568;
  }
  .green {
    background-color: #036b28;
  }
  .orange {
    background-color: #ef7700;
  }
  .red {
    background-color: #b00707;
  }
  .card {
    transition: all 0.2s ease-in-out;
    cursor: pointer;
  }
  .card:hover {
    transform: scale(1.01);
  }
  .card h6 {
    font-size: 14px;
  }

  
  .iframe-thumbnail-wrapper {
    position: relative;
    width: 100px;   /* thumbnail size */
    height: 100px;
    overflow: hidden;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .iframe-thumbnail-wrapper:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
  }

  .iframe-thumbnail-wrapper iframe {
    width: 100%;
    height: 100%;
    border: none;
    pointer-events: none; /* prevent iframe interaction on hover */
  }

  .iframe-text-overlay {
    position: absolute;
    bottom: 8px;
    left: 8px;
    right: 8px;
    color: white;
    background: rgba(0,0,0,0.5);
    padding: 4px 8px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 4px;
    text-align: center;
    pointer-events: none;
    user-select: none;
  }
</style>

<h1 class="h3 mb-0 text-gray-800">
  <span class="greeting-text">{{greeting}}</span>, {{ request.user.first_name }}
  {{ request.user.last_name }}
</h1>
{% if request.user.user_account.can_report %}
<div class="dropdown">
  <a
    class="btn btn-primary dropdown-toggle"
    href="#"
    role="button"
    data-toggle="dropdown"
    aria-expanded="false">
    Reports
  </a>

  <div class="dropdown-menu">
    <a
      class="dropdown-item"
      href="{% url 'acr:job_cost_sheet_detail' module=module %}"
      >Job Cost Sheet</a
    >
    <a
      class="dropdown-item"
      href="{% url 'acr:ageing_analysis' module=module %}"
      >Ageing Analysis</a
    >
   
    <a
      class="dropdown-item"
      href="{% url 'acr:ledger_report' module=module %}"
      >Ledgers</a
    >
    <a
      class="dropdown-item"
      href="{% url 'acr:trial_balance_report' module=module %}"
      >Trial Balance</a
    >
    <a
      class="dropdown-item"
      href="{% url 'acr:profit_loss_report' module=module %}"
      >Profit & Loss</a
    >
    <a
      class="dropdown-item"
      href="{% url 'acr:gstr1_recievable' module=module %}"
      >GSTR1 Recievale</a
    >
    <a
      class="dropdown-item"
      href="{% url 'acr:gstr2_payable' module=module %}"
      >GSTR2 Payable</a
    >
    <a class="dropdown-item" href="{% url 'acr:gstr3b' module=module %}"
      >GSTR3B</a
    >
    <a
      class="dropdown-item"
      href="{% url 'acr:reciept_tds' module=module %}"
      >Reciept TDS</a
    >
    <a
      class="dropdown-item"
      href="{% url 'acr:payment_tds' module=module %}"
      >Payment TDS</a
    >
    <a
      class="dropdown-item"
      href="{% url 'acr:sales_outstanding' module=module %}"
      >Debtors O/S</a
    >
    <a
      class="dropdown-item"
      href="{% url 'acr:direct_creditors_outstanding' module=module %}"
      >Direct Cr. O/S</a
    >
    <a
      class="dropdown-item"
      href="{% url 'acr:indirect_creditors_outstanding' module=module %}"
      >Indirect Cr. O/S</a
    >
  </div>
</div>
{% endif %} 
{% endblock %}
 {% block dashboard_content %} 
{% if request.user.user_account.can_view_bills %}


<div class="row">

<div class="col-md-10 col-sm-12">
<marquee style="background-color:rgb(63, 1, 63);color:white; border-radius: 10px;" scrollamount="4" >

{% for invoice in current_month_invoices %}

  <h6 style="color:white; margin-top:9px;">
   
    Your bills for the month of {{ invoice.invoice_month }} {{ invoice_year }}
  </h6>


  <p style="color:white">
    Invoice No: {{ invoice.invoice_no }} - Invoice Date: {{ invoice.date_of_invoice }} — Invoice Amount: {{ invoice.balance }} {{invoice.payment_status}}
    
  </p>

  {% if invoice.days_left != None %}
    {% if invoice.days_left > 0 %}
      <strong class="blinking-highlight">
        Kindly Pay the amount before the Due Date: {{ invoice.due_date }}
      </strong>
    {% elif invoice.days_left == 0 %}
      <strong><i>Due today</i></strong>
    {% else %}
      <strong class="overdue-highlight" style="color:red;">
        Overdue by {{ invoice.days_left }} day(s)
      </strong>
    {% endif %}
  {% else %}
    <strong>No due date</strong>
  {% endif %}
{% empty %}
  <p style="color:white;">No invoices found.</p>
{% endfor %}

</marquee>


{% if pending_count > 0 %}
  <div class="mt-3 alert alert-warning font-weight-bold">
    {{ pending_count }} invoice  are still pending 
    
    <ul>
  {% for invoice in pending_invoices %}
    <li>Invoice No: {{ invoice.invoice_no }} | Balance: ₹{{ invoice.balance }}</li>
  {% endfor %}
</ul>
   <!--  -->

Total pending balance ₹{{ pending_total_amount }}   

<br>
<strong style="color: rgb(255, 0, 0); font-weight: bold; animation: blinker 2s linear infinite;" >
 kindly pay the September 2025 bill amount till September 30,2025 otherwise your software will be deactivate from server side </strong><br>
<button type="submit" class="btn btn-primary" >
      <a href="{% url 'accounting:bop_details' module=module %}"><span style="color:white">View all bills</span></a></button>
      
      
  </div>
  {% else %}
  <div class="mt-3">
    <button type="submit" class="btn btn-primary" >
      <a href="{% url 'accounting:bop_details' module=module %}"><span style="color:white">View all bills</span></a></button>
      
      
  </div>


{% endif %}
</div>
<div class="col-md-2 col-sm-12">
<div class="col-md-2 col-sm-12">
  
    {% for invoice in current_month_invoices %}
      {% if forloop.counter <= 2 and invoice.bill_upload %}
        <a href="{{ invoice.bill_upload.url }}" target="_blank" title="Open full document">
          <div class="iframe-thumbnail-wrapper">
            <iframe src="{{ invoice.bill_upload.url }}?output=embed"></iframe>
            <div class="iframe-text-overlay">PDF</div>
          </div>
        </a>



      {% endif %}
    {% endfor %}

    {% if  current_month_invoices|length > 2  %}
     
      <button type="button" class="btn btn-primary mt-2" style="min-width: 160px;" data-toggle="modal" data-target="#remainingBillsModal">
        View all current month bills ({{ current_month_invoices|length}})
      </button>
</a>
      <div class="modal fade" id="remainingBillsModal" tabindex="-1" role="dialog" aria-labelledby="remainingBillsModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="remainingBillsModalLabel">Remaining Bills</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body" style="max-height:400px; overflow-y:auto;">
             
                <table class="table  table-bordered table-sm">
                  <thead style="background-color:grey">
                    <tr>
                      <th>Invoice No</th>
                      <th>Date</th>
                      <th>Amount (₹)</th>
                      <th>Bill</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for invoice in current_month_invoices %}
                      <tr>
                        <td>{{ invoice.invoice_no }}</td>
                        <td>{{ invoice.date_of_invoice }}</td>
                        <td>{{ invoice.balance }}</td>
                        <td>
                          {% if invoice.bill_upload %}
                            <a href="{{ invoice.bill_upload.url }}" target="_blank" class="btn btn-sm btn-link p-0">View Bill</a>
                          {% else %}
                            <span class="text-muted">No bill uploaded</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              <!-- </div> -->
              
            </div>
          </div>
        </div>
      </div>
    {% endif %}

</div>
    
</div>
</div>



{% if request.user.user_account.can_view_bills %}

<button type="button" class="btn btn-primary mt-2" style="min-width: 50px;" data-toggle="modal" data-target="#soaModal">
  View Scalesoft technologies Account Statement
</button>
{% endif %}
</a>
<div class="modal fade" id="soaModal" tabindex="-1" role="dialog" aria-labelledby="soaModalLabel" aria-hidden="true">
 <div class="modal-dialog" role="document">
   <div class="modal-content">
     <div class="modal-header">
       <h5 class="modal-title" id="soaModalLabel">STATEMENT OF ACCOUNTS</h5>
       <button type="button" class="close" data-dismiss="modal" aria-label="Close">
         <span aria-hidden="true">&times;</span>
       </button>
     </div>
     <div class="modal-body" style="max-height:400px; overflow-y:auto;">
      
       <form
        action="{% url 'accounting:generate_soa_pdf' module=module %}"

       method="post">
       {% csrf_token %}
   <div class="row mb-1">
     
   <div class="col-md-4 col-sm-12 mb-3">
     <label for="from_date">From</label>
     <input type="date" name="from_date" value="{{from_date|date:'Y-m-d'}}" class="form-control" id="from_date">
   </div>

   <div class="col-md-4 col-sm-12 mb-3">
     <label for="to_date">To</label>
     <input type="date" name="to_date" value="{{to_date|date:'Y-m-d'}}" class="form-control" id="to_date">
   </div>
   
<div class="col-md-3 mt-1">
     <!-- <button type="submit" class="mt-6 btn btn-sm btn-primary">GENERATE PDF</button>  -->
     <button type="submit" class="btn btn-primary mt-4" style="min-width: 140px;">Generate PDF</button>

     
   </div>
     </div>

       </form>

       
     </div>
   </div>
 </div>
</div>



<form
  action="{% url 'dashboard:accounting_dashboard' module=module %}"
  method="post">
  {% csrf_token %}
  <div class="row mb-1">
    <div class="col-md-2">
      <label for="company">Company</label>
      <select name="company" class="form-control form-control-sm" id="company">
        {% if selected_company == 'all' %}
        <option value="all" selected>All</option>
        {% else %}
        <option value="all">All</option>
        {% endif %}
        {% for i in global_companies %} 
        {% if i.id == selected_company %}
        <option value="{{i.id}}" selected>{{i}} ({{i.branch_name}})</option>
        {% else %}
        <option value="{{i.id}}">{{i}} ({{i.branch_name}})</option>
        {% endif %} 
        {% endfor %}
      </select>
    </div>

   
<div class="col-md-3 mt-1">
      <button type="submit" class="mt-4 btn btn-sm btn-primary">Search</button> 

      
    </div>
  </div>

  
</form>

{% endif %}


{% if transactions %}
<div id="soaTable" style="display: none; margin-top: 20px;">
  <table class="table table-bordered">
    <thead style="background-color:grey">
      <tr>
        <th>Date</th>
        <th>Transaction</th>
        <th>Details</th>
        <th>Amount</th>
        <th>Payments</th>
        <th>Balance</th>
      </tr>
    </thead>
    <tbody>
      {% for t in transactions %}
      <tr>
        <td>{{ t.date }}</td>
        <td>{{ t.type }}</td>
        <td>{{ t.remark }}</td>
        <td>
          {% if t.amount > 0 %}
            {{ t.amount }}
           

          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if t.amount < 0 %}
            {{ t.amount|absolute }}
           

          {% else %}
            -
          {% endif %}
        </td>
        <td>{{ t.balance }}</td>
      </tr>
      {% endfor %}

      <tr style="background-color: #e9e9e9; font-weight: bold;">
        <td colspan="5" style="text-align: right;">Balance Due:</td>
        <td>{{ balance_due }}</td>
      </tr>
      
    </tbody>
  </table>
</div>


{% endif %}


<div class="row mb-1">
  <div class="col-md-3 col-sm-12 mb-1">
    <a
      href="{% url 'accounting:recievable_invoice_details' module='accounting' %}"
      style="text-decoration: none">
      <div class="card green">
        <div class="card-body">
          <h6 class="card-title text-white">
            <i class="bi bi-receipt"></i> Total Recievable Invoices
          </h6>
          <div class="row">
            <div class="col-6">
              <h6 class="text-white">Proforma</h6>
              <h6 class="text-white">{{proforma_invoice_count}}</h6>
            </div>
            <div class="col-6">
              <h6 class="text-white">E-invoiced</h6>
              <h6 class="text-white">{{final_rec_invoice_count}}</h6>
            </div>
          </div>
        </div>
      </div>
    </a>
  </div>

  <div class="col-md-3 col-sm-12 mb-1">
    <a
      href="{% url 'accounting:credit_note_details' module='accounting' %}"
      style="text-decoration: none">
      <div class="card blue">
        <div class="card-body">
          <h6 class="card-title text-white">
            <i class="bi bi-receipt"></i> Total Credit Note
          </h6>
          <div class="row">
            <div class="col-6">
              <h6 class="text-white">Proforma</h6>
              <h6 class="text-white">{{proforma_crn_count}}</h6>
            </div>
            <div class="col-6">
              <h6 class="text-white">E-invoiced</h6>
              <h6 class="text-white">{{final_crn_count}}</h6>
            </div>
          </div>
        </div>
      </div>
    </a>
  </div>

  <div class="col-md-3 col-sm-12 mb-1">
    <a
      href="{% url 'accounting:invoice_payable_details' module='accounting' %}"
      style="text-decoration: none">
      <div class="card red">
        <div class="card-body">
          <h6 class="card-title text-white">
            <i class="bi bi-receipt"></i> Total Payable Invoices
          </h6>

          <div class="row">
            <div class="col-6">
              <h6 class="text-white">Unfinal</h6>
              <h6 class="text-white">{{unfinal_invoice_payable_count}}</h6>
            </div>
            <div class="col-6">
              <h6 class="text-white">Final</h6>
              <h6 class="text-white">{{final_invoice_payable_count}}</h6>
            </div>
          </div>

        </div>
      </div>
    </a>
  </div>

  <div class="col-md-3 col-sm-12 mb-1">
    <a
      href="{% url 'accounting:debit_note_details' module='accounting' %}"
      style="text-decoration: none">
      <div class="card orange">
        <div class="card-body">
          <h6 class="card-title text-white">
            <i class="bi bi-receipt"></i> Total Debit Note
          </h6>
          <div class="row">
            <div class="col-6">
              <h6 class="text-white">Count</h6>
              <h6 class="text-white">{{drn_count}}</h6>

            </div>
          </div>
        </div>
      </div>
    </a>
  </div>
 
</div>



<script>


  document.getElementById("showTableBtn").addEventListener("click", function() {
    var tableDiv = document.getElementById("soaTable");
    if (tableDiv.style.display === "none" || tableDiv.style.display === "") {
      tableDiv.style.display = "block";  
    } else {
      tableDiv.style.display = "none";  
    }
  });
</script>
{% endblock %}
