{% extends 'dashboard/index.html' %}

{% block dashoard_title %} 
{% if update %}
Update Multiple Account Reciept Voucher - 
{% else %}
Create Multiple Account Reciept Voucher - 
{% endif %}
{% endblock %}

{% block dashboard_heading %}
<h1 class="h5 mb-0 text-gray-800">
    {% if update %}
    Update Multiple Account Reciept Voucher
    {% else %}
    Create Multiple Account Reciept Voucher
    {% endif %}
</h1>

<style>
    table th, table td{
        padding: 0!important;
       
    }
    
</style>

<a href="{% url 'accounting:multiple_reciept_voucher_details' module=module %}"
    class="d-inline-block btn  btn-primary shadow-sm"><i class="fas fa-eye  text-white-50"></i> View List</a>
{% endblock %}


{% block dashboard_content %}



<form enctype="multipart/form-data"  method="post">
    {% csrf_token %}
    {% include 'error_component.html' %}
    <div class="row">

        
        <div class="col-md-3 col-sm-12 mb-1">
            {{ form.voucher_no }}
            <label for="id_company_type" class="required">Choose Company</label>
            {{ form.company_type }}
        </div>
    
       
        <div class="col-md-3 col-sm-12 mb-1">
            <label class="required" for="id_voucher_date">Voucher Date</label>
            {{ form.voucher_date }}
        </div>
        <div class="col-md-3 col-sm-12 mb-1">
            <label class="required" for="id_instrument_no">Insrument No</label>
            {{ form.instrument_no }}
        </div>
       
        
        <div class="col-md-3 col-sm-12 mb-1" id="from_bank_div">
            <label class="required" for="id_from_bank">Bank</label>
            {{ form.to_bank }}
        </div>

       
       
        <div class="col-md-3 col-sm-12 mb-1">
            <label class="required" for="id_advance_amount">Received Amount</label>
            {{ form.advance_amount }}
        </div>
           

        <div class="col-md-3 col-sm-12 mb-1">
            <label class="required" for="id_bank_charges">Bank Charges</label>
            {{ form.bank_charges }}
        </div>
       

     
        <div class="col-md-12 col-sm-12 mb-1">
            <label for="id_narration">Narration</label>
            {{ form.narration }}
        </div>
       

        <div class="col-12">
            {% if update %}
                <input type="hidden" name="total_rows" id="total_rows" value="{{form.instance.reciept_voucer_advance.all|length}}">
            {% else %}
                <input type="hidden" name="total_rows" id="total_rows" value="0">
            {% endif %}
            <div class="table-responsive">
                <table class="table table-bordered" id="party_reciept">
    
                    <tr>
                        <th class="required" >Party</th>
                        <th class="required" >Party Address</th>
                        <th class="required" >Amount</th>
                        <th></th>
                    </tr>
                    
                    {% for i in data.advance_voucher.all %}
                    <tr id="entry-{{forloop.counter}}">
    
                        <td>
                            <input type="hidden" name="is_active-{{forloop.counter}}" value="yes" id="is_active-{{forloop.counter}}">
                            <input type="hidden" name="is_update-{{forloop.counter}}" value="yes" id="is_update-{{forloop.counter}}">
                            <input type="hidden" name="voucher_id-{{forloop.counter}}" value="{{i.id}}" id="voucher_id-{{forloop.counter}}">
    
                           <select class="form-control" onchange="getOnlyPartyAdress('party-{{forloop.counter}}','party_address-{{forloop.counter}}')" name="party-{{forloop.counter}}" required id="party-{{forloop.counter}}">
                            {% for party in global_parties %}
                            {% if party.id == i.party_name.id %}
                            <option value="{{party.id}}" selected>{{party}}</option>
                            {% else %}
                            <option value="{{party.id}}">{{party}}</option>
                            {% endif %}
                            {% endfor %}
                           </select>
                        </td>
                        <td>
                            <select class="form-control" name="party_address-{{forloop.counter}}" required id="party_address-{{forloop.counter}}"></select>
                            
                          
                        </td>
                        <td>
                            <input class="form-control" onchange="calculatePaidAmount()" onkeyup="calculatePaidAmount()" type="number" step="0.01" id="amount-{{forloop.counter}}" required value="0" min="0" name="amount-{{forloop.counter}}">
                        </td>
                        <td>
                            <div class="btn btn-sm btn-danger" onclick="deleteRow('{{forloop.counter}}')">Remove</div>
                        </td>
                    </tr>
                    {% endfor %}
                   
                </table>
            </div>
            <div class="text-right w-100">
                <button type="button" class="btn btn-sm btn-primary" onclick="addRow()"> Add More </button>
            </div>
        </div>

    </div>
 
    <button type="submit"  class="btn btn-primary" id="submit-btn">
        {% if update %}
        Save Update
        {% else %}
        Save Create
        {% endif %}

    </button>

    {% if update %}
    <input type="hidden" id="is_update" value="true">


    {% else %}
    <input type="hidden" id="is_update" value="false">
    {% endif %}
    <input type="hidden" id="user_company" value="{{ request.user.user_account.office.id }}">
    <input type="hidden" id="user_back_permission" value="{{ request.user.user_account.can_backlog }}">

</form>






{% endblock %}

{% block js %}
<script>

    if(document.getElementById('user_back_permission').value == "False"){
        setDateLimit(3,document.getElementById('id_voucher_date'))
    }


    function removeOptions(selectElement) {
        var i, L = selectElement.options.length - 1;
        for(i = L; i >= 0; i--) {
           selectElement.remove(i);
        }
        }

        async function getOnlyPartyAdress(id,address_id){
            try{
                
                var party = document.getElementById(id).value
                var adresses = await axios.get('/api/v1/party/details?party='+party)
                adresses = adresses.data
                const select = document.getElementById(address_id); 
                if(is_update == 'true'){
                var value = select.value
                }
                else{
                    var  value = 0
                }
                removeOptions(select);
                select.innerHTML = ''
                select.required = true
                var newOption = new Option("Choose Address","")
                select.add(newOption);
                
                adresses.map(item=>{
                    var newOption = new Option(item.branch,item.id)
                    if(item.id == value || adresses.length == 1){
                        newOption.selected = true
                    }
                    select.add(newOption);
                })
        
            }catch(err){
                
            }
          }
    
          var is_update = document.getElementById('is_update').value

    var currentRowNumber = parseInt(document.getElementById('total_rows').value) || 0
    var availableRowNumber = parseInt(document.getElementById('total_rows').value) || 0

    const addRow = () => {
        currentRowNumber += 1
        availableRowNumber += 1
        
        var newRow = document.getElementById('party_reciept').insertRow(-1)
        newRow.id = `entry-${currentRowNumber}`
        newRow.classList.add("entry")
        var party = newRow.insertCell(0)
        var party_address = newRow.insertCell(1)
       
        var amount = newRow.insertCell(2)
        var delete_cell = newRow.insertCell(3)

        party.innerHTML = `
        <input type="hidden" name="is_active-${currentRowNumber}" value="yes" id="is_active-${currentRowNumber}">
        <input type="hidden" name="is_update-${currentRowNumber}" value="no" id="is_update-${currentRowNumber}">
        
        <select required class="form-control" name="party-${currentRowNumber}" onchange="getOnlyPartyAdress('party-${currentRowNumber}','party_address-${currentRowNumber}')" id="party-${currentRowNumber}">
            
            <option value="" selected disabled hidden>Choose Party</option>
            {% for i in global_parties %}
                <option value="{{i.id}}">{{i}}</option>
            {% endfor %}
        </select>
        `

        party_address.innerHTML = `
        <select class="form-control" required name="party_address-${currentRowNumber}" required id="party_address-${currentRowNumber}"></select>
        `

        amount.innerHTML = `

            <input class="form-control" onchange="calculatePaidAmount()" onkeyup="calculatePaidAmount()" type="number" required step="0.01" id="amount-${currentRowNumber}" name="amount-${currentRowNumber}">
        `

        

        delete_cell.innerHTML = `
                <div class="btn btn-sm btn-danger" onclick="deleteRow(${currentRowNumber})">Remove</div>
            `
        document.getElementById('total_rows').value = currentRowNumber
    }



    const deleteRow = (index) => {
        document.getElementById(`is_active-${index}`).value = "no"
        document.getElementById(`party-${index}`).required = false
        document.getElementById(`party_address-${index}`).required = false
        document.getElementById(`amount-${index}`).required = false
        document.getElementById(`entry-${index}`).style.display = 'none'
        availableRowNumber -= 1
        calculatePaidAmount()
    }


    const calculatePaidAmount = () => {
        var amount = 0
        for(var i=1; i<=currentRowNumber; i++){
            if(document.getElementById('is_active-'+i).value == "yes"){
                amount += parseFloat(document.getElementById('amount-'+i).value)
            }
        }

        document.getElementById('id_advance_amount').value = amount
    }
    



</script>
{% endblock %}